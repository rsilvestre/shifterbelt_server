{"version":3,"sources":["websocket-adapter.es6"],"names":[],"mappings":"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","file":"websocket-adapter.js","sourcesContent":["/**\n * Created by michaelsilvestre on 22/04/15\n */\n\nimport socketIo from \"socket.io\"\nimport socketRedis from \"socket.io-redis\"\nimport redis from \"redis\"\nimport * as config from \"../config/config.js\"\nimport AbsAdapter from \"./absAdapter.js\"\nimport _ from \"underscore\"\nimport http from 'http'\nimport url from 'url'\nimport { logger } from \"../lib/logger.js\"\n\nexport default class WebsocketAdapter extends AbsAdapter {\n  constructor(callback) {\n    super('websocket');\n\n    this.init(callback);\n  }\n\n  init(callback) {\n    let websocketConfig = config.adapters.getConfig(\"websocket\");\n    let redisConfig = config.adapters.getConfig(\"memory\");\n\n    var redisURL = url.parse(redisConfig.defaultUrl());\n\n    let pub = redis.createClient(redisURL.port, redisURL.hostname, { no_ready_check: true });\n    if (redisURL.auth) {\n      pub.auth(redisURL.auth.split(\":\")[1]);\n    }\n\n    let sub = redis.createClient(redisURL.port, redisURL.hostname, { no_ready_check: true, detect_buffers: true });\n    if (redisURL.auth) {\n      sub.auth(redisURL.auth.split(\":\")[1]);\n    }\n\n    this._server = http.createServer((req, res) => {\n      res.end('thank you');\n    });\n\n    this._io = socketIo.listen(this._server);\n    this._io.adapter(socketRedis({ pubClient: pub, subClient: sub }));\n\n    this._server.listen(websocketConfig.port);\n\n    _.each(this._io.nsps, (nsp) => {\n      nsp.on('connection', (socket) => {\n        if (socket.auth) {\n          console.log(`removing socket from: ${nsp.name}`);\n          logger.info(`removing socket from: ${nsp.name}`);\n          delete nsp.connected[socket.id];\n        }\n      });\n    });\n    this._nsp = this._io.of(websocketConfig.namespace);\n    console.log('socket.io successfull connected');\n    logger.info('socket.io successfull connected');\n    callback(this);\n  }\n\n  /**\n   *\n   * @returns {socket.io}\n   */\n  get io() {\n    return this._io;\n  }\n\n  /**\n   *\n   * @returns {Array|*|String}\n   */\n  get nsp() {\n    return this._nsp;\n  }\n\n  connection(callback) {\n    this._nsp.on(\"connection\", callback);\n  }\n\n  close(next) {\n    console.log('close websocket');\n    logger.info('close websocket');\n    this._io.close();\n    console.log('close server');\n    logger.info('close server');\n    this._server.close();\n    next();\n  }\n}\n"]}