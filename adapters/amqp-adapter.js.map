{"version":3,"sources":["amqp-adapter.es6"],"names":[],"mappings":"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","file":"amqp-adapter.js","sourcesContent":["/**\n * Created by michaelsilvestre on 20/04/15\n */\n\nimport amqp from \"amqplib\"\nimport when from \"when\"\nimport * as config from \"../config/config.js\"\nimport AbsAdapter from \"./absAdapter.js\"\nimport { logger } from \"../lib/logger.js\"\n\nexport default class AmqpAdapter extends AbsAdapter {\n  constructor(callback) {\n    super(\"queue\");\n\n    this._connPub = null;\n    this._connSub = null;\n    this._chPub = null;\n    this._chSub = null;\n    this.init(() => {\n      callback(this);\n    });\n  }\n\n  init(callback) {\n    this.createSubChannel(callback, (...arg) => {\n      this.createPubChannel(...arg);\n    });\n\n    process.once('SIGINT', () => {\n      console.log('Got SIGINT.  Press Control-D to exit.');\n      logger.info('Got SIGINT.  Press Control-D to exit.');\n      console.log('close channel pub');\n      logger.info('close channel pub');\n      let ok = this._chPub.close();\n      ok = ok.then((err) => {\n        if (err) throw err;\n        console.log('channel pub closed');\n        logger.info('channel pub closed');\n        console.log('close channel sub');\n        logger.info('close channel sub');\n        return this._chSub.close();\n      });\n      ok = ok.then((err) => {\n        if (err) throw err;\n        console.log('channel sub closed');\n        logger.info('channel sub closed');\n        console.log('close connection pub');\n        logger.info('close connection pub');\n        return this._connPub.close();\n      });\n      ok = ok.then((err) => {\n        if (err) throw err;\n        console.log('connection pub closed');\n        logger.info('connection pub closed');\n        console.log('close connection sub');\n        logger.info('close connection sub');\n        return this._connSub.close();\n      });\n      ok.then((err) => {\n        if (err) throw err;\n        console.log('connection sub closed');\n        logger.info('connection sub closed');\n        process.exit(0);\n      });\n\n\n    });\n  }\n\n  createSubChannel(callback, next) {\n    let amqpConfig = config.adapters.getConfig(\"queue\");\n    amqp.connect(amqpConfig.url).then((conn) => {\n      this._connSub = conn;\n      console.log(\"amqb sub connected successfull connected\");\n      logger.info(\"amqb sub connected successfull connected\");\n      return conn.createChannel().then((ch) => {\n        this._chSub = ch;\n        return next(callback);\n      });\n    }).then(null, console.warn);\n  }\n\n  createPubChannel(next) {\n    let amqpConfig = config.adapters.getConfig(\"queue\");\n    amqp.connect(amqpConfig.url).then((conn) => {\n      this._connPub = conn;\n      console.log(\"amqb pub connected successfull connected\");\n      logger.info(\"amqb pub connected successfull connected\");\n      return when(conn.createChannel().then((ch) => {\n        this._chPub = ch;\n        next();\n      }))\n    }).then(null, console.warn);\n  }\n\n  get chSub() {\n    return this._chSub;\n  }\n\n  get chPub() {\n    return this._chPub;\n  }\n}"]}