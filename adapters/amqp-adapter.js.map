{"version":3,"sources":["amqp-adapter.es6"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;uBAIiB,SAAS;;;;oBACT,MAAM;;;;8BACC,qBAAqB;;IAAjC,MAAM;;4BACK,iBAAiB;;;;2BACjB,kBAAkB;;IAEpB,WAAW;AACnB,WADQ,WAAW,CAClB,QAAQ,EAAE;;;0BADH,WAAW;;AAE5B,+BAFiB,WAAW,6CAEtB,OAAO,EAAE;;AAEf,QAAI,CAAC,QAAQ,GAAG,IAAI,CAAC;AACrB,QAAI,CAAC,QAAQ,GAAG,IAAI,CAAC;AACrB,QAAI,CAAC,MAAM,GAAG,IAAI,CAAC;AACnB,QAAI,CAAC,MAAM,GAAG,IAAI,CAAC;AACnB,QAAI,CAAC,IAAI,CAAC,YAAM;AACd,cAAQ,OAAM,CAAC;KAChB,CAAC,CAAC;GACJ;;YAXkB,WAAW;;eAAX,WAAW;;WAa1B,cAAC,QAAQ,EAAE;;;AACb,UAAI,CAAC,gBAAgB,CAAC,QAAQ,EAAE,YAAY;0CAAR,GAAG;AAAH,aAAG;;;AACrC,eAAK,gBAAgB,MAAA,SAAI,GAAG,CAAC,CAAC;OAC/B,CAAC,CAAC;KACJ;;;WAEI,eAAC,IAAI,EAAE;;;AACV,mBAtBK,MAAM,CAsBJ,IAAI,CAAC,uCAAuC,CAAC,CAAC;AACrD,mBAvBK,MAAM,CAuBJ,IAAI,CAAC,mBAAmB,CAAC,CAAC;AACjC,UAAI,EAAE,GAAG,IAAI,CAAC,MAAM,CAAC,KAAK,EAAE,CAAC;AAC7B,QAAE,GAAG,EAAE,CAAC,IAAI,CAAC,UAAC,GAAG,EAAK;AACpB,YAAI,GAAG,EAAE,MAAM,GAAG,CAAC;AACnB,qBA3BG,MAAM,CA2BF,IAAI,CAAC,oBAAoB,CAAC,CAAC;AAClC,qBA5BG,MAAM,CA4BF,IAAI,CAAC,mBAAmB,CAAC,CAAC;AACjC,eAAO,OAAK,MAAM,CAAC,KAAK,EAAE,CAAC;OAC5B,CAAC,CAAC;AACH,QAAE,GAAG,EAAE,CAAC,IAAI,CAAC,UAAC,GAAG,EAAK;AACpB,YAAI,GAAG,EAAE,MAAM,GAAG,CAAC;AACnB,qBAjCG,MAAM,CAiCF,IAAI,CAAC,oBAAoB,CAAC,CAAC;AAClC,qBAlCG,MAAM,CAkCF,IAAI,CAAC,sBAAsB,CAAC,CAAC;AACpC,eAAO,OAAK,QAAQ,CAAC,KAAK,EAAE,CAAC;OAC9B,CAAC,CAAC;AACH,QAAE,GAAG,EAAE,CAAC,IAAI,CAAC,UAAC,GAAG,EAAK;AACpB,YAAI,GAAG,EAAE,MAAM,GAAG,CAAC;AACnB,qBAvCG,MAAM,CAuCF,IAAI,CAAC,uBAAuB,CAAC,CAAC;AACrC,qBAxCG,MAAM,CAwCF,IAAI,CAAC,sBAAsB,CAAC,CAAC;AACpC,eAAO,OAAK,QAAQ,CAAC,KAAK,EAAE,CAAC;OAC9B,CAAC,CAAC;AACH,QAAE,CAAC,IAAI,CAAC,UAAC,GAAG,EAAK;AACf,YAAI,GAAG,EAAE,MAAM,GAAG,CAAC;AACnB,qBA7CG,MAAM,CA6CF,IAAI,CAAC,uBAAuB,CAAC,CAAC;AACrC,YAAI,EAAE,CAAC;OACR,CAAC,CAAC;KACJ;;;WAEe,0BAAC,QAAQ,EAAE,IAAI,EAAE;;;AAC/B,UAAI,UAAU,GAAG,MAAM,CAAC,QAAQ,CAAC,SAAS,CAAC,OAAO,CAAC,CAAC;AACpD,2BAAK,OAAO,CAAC,UAAU,CAAC,GAAG,CAAC,CAAC,IAAI,CAAC,UAAC,IAAI,EAAK;AAC1C,eAAK,QAAQ,GAAG,IAAI,CAAC;AACrB,qBAtDG,MAAM,CAsDF,IAAI,CAAC,0CAA0C,CAAC,CAAC;AACxD,eAAO,IAAI,CAAC,aAAa,EAAE,CAAC,IAAI,CAAC,UAAC,EAAE,EAAK;AACvC,iBAAK,MAAM,GAAG,EAAE,CAAC;AACjB,iBAAO,IAAI,CAAC,QAAQ,CAAC,CAAC;SACvB,CAAC,CAAC;OACJ,CAAC,CAAC,IAAI,CAAC,IAAI,EAAE,OAAO,CAAC,IAAI,CAAC,CAAC;KAC7B;;;WAEe,0BAAC,IAAI,EAAE;;;AACrB,UAAI,UAAU,GAAG,MAAM,CAAC,QAAQ,CAAC,SAAS,CAAC,OAAO,CAAC,CAAC;AACpD,2BAAK,OAAO,CAAC,UAAU,CAAC,GAAG,CAAC,CAAC,IAAI,CAAC,UAAC,IAAI,EAAK;AAC1C,eAAK,QAAQ,GAAG,IAAI,CAAC;AACrB,qBAlEG,MAAM,CAkEF,IAAI,CAAC,0CAA0C,CAAC,CAAC;AACxD,eAAO,uBAAK,IAAI,CAAC,aAAa,EAAE,CAAC,IAAI,CAAC,UAAC,EAAE,EAAK;AAC5C,iBAAK,MAAM,GAAG,EAAE,CAAC;AACjB,cAAI,EAAE,CAAC;SACR,CAAC,CAAC,CAAA;OACJ,CAAC,CAAC,IAAI,CAAC,IAAI,EAAE,OAAO,CAAC,IAAI,CAAC,CAAC;KAC7B;;;SAEQ,YAAG;AACV,aAAO,IAAI,CAAC,MAAM,CAAC;KACpB;;;SAEQ,YAAG;AACV,aAAO,IAAI,CAAC,MAAM,CAAC;KACpB;;;SA9EkB,WAAW;;;qBAAX,WAAW","file":"amqp-adapter.js","sourcesContent":["/**\n * Created by michaelsilvestre on 20/04/15\n */\n\nimport amqp from \"amqplib\"\nimport when from \"when\"\nimport * as config from \"../config/config.js\"\nimport AbsAdapter from \"./absAdapter.js\"\nimport { logger } from \"../lib/logger.js\"\n\nexport default class AmqpAdapter extends AbsAdapter {\n  constructor(callback) {\n    super(\"queue\");\n\n    this._connPub = null;\n    this._connSub = null;\n    this._chPub = null;\n    this._chSub = null;\n    this.init(() => {\n      callback(this);\n    });\n  }\n\n  init(callback) {\n    this.createSubChannel(callback, (...arg) => {\n      this.createPubChannel(...arg);\n    });\n  }\n\n  close(next) {\n    logger.info('Got SIGINT.  Press Control-D to exit.');\n    logger.info('close channel pub');\n    let ok = this._chPub.close();\n    ok = ok.then((err) => {\n      if (err) throw err;\n      logger.info('channel pub closed');\n      logger.info('close channel sub');\n      return this._chSub.close();\n    });\n    ok = ok.then((err) => {\n      if (err) throw err;\n      logger.info('channel sub closed');\n      logger.info('close connection pub');\n      return this._connPub.close();\n    });\n    ok = ok.then((err) => {\n      if (err) throw err;\n      logger.info('connection pub closed');\n      logger.info('close connection sub');\n      return this._connSub.close();\n    });\n    ok.then((err) => {\n      if (err) throw err;\n      logger.info('connection sub closed');\n      next();\n    });\n  }\n\n  createSubChannel(callback, next) {\n    let amqpConfig = config.adapters.getConfig(\"queue\");\n    amqp.connect(amqpConfig.url).then((conn) => {\n      this._connSub = conn;\n      logger.info(\"amqb sub connected successfull connected\");\n      return conn.createChannel().then((ch) => {\n        this._chSub = ch;\n        return next(callback);\n      });\n    }).then(null, console.warn);\n  }\n\n  createPubChannel(next) {\n    let amqpConfig = config.adapters.getConfig(\"queue\");\n    amqp.connect(amqpConfig.url).then((conn) => {\n      this._connPub = conn;\n      logger.info(\"amqb pub connected successfull connected\");\n      return when(conn.createChannel().then((ch) => {\n        this._chPub = ch;\n        next();\n      }))\n    }).then(null, console.warn);\n  }\n\n  get chSub() {\n    return this._chSub;\n  }\n\n  get chPub() {\n    return this._chPub;\n  }\n}"]}