{"version":3,"sources":["authenticate.es6"],"names":[],"mappings":"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","file":"authenticate.js","sourcesContent":["/**\n * Created by michaelsilvestre on 25/04/15\n */\n\nimport { adapters } from \"../adapters/absAdapter.js\"\nimport { LinkDevice } from \"../modules/message.js\"\nimport Authentication from \"../modules/authentication.js\"\nimport { logger } from \"../lib/logger.js\"\n\nimport _ from \"underscore\"\n\nexport let authenticateInit = () => {\n  let websocketAdapter = adapters.getAdapter(\"websocket\");\n  websocketAdapter.connection(function(socket) {\n    let device = null;\n    console.log(\"a device is connected\");\n    logger.info(\"a device is connected\");\n    socket.auth = false;\n    //socket.emit('event', \"first message\");\n\n    socket.on('authenticate', (data) => {\n      let authentication = new Authentication(data);\n      authentication.checkAuthToken((err, success) => {\n        if (err) {\n          return socket.emit('error_system', err.message);\n        }\n        if (!success) {\n          return;\n        }\n        device = success;\n\n        let linkDevice = new LinkDevice(device, socket, (err, device, slaves) => {\n          if (err) {\n            return console.warn(err);\n          }\n\n          console.log(`Authenticated socket: ${socket.id}`);\n          logger.info(`Authenticated socket: ${socket.id}`);\n          socket.auth = true;\n\n          _.each(websocketAdapter.io.nsps, (nsp) => {\n            console.log(`restoring socket to: ${nsp.name}`);\n            logger.info(`restoring socket to: ${nsp.name}`);\n            nsp.connected[socket.id] = socket;\n          });\n\n          socket.emit('authenticated');\n          socket.emit('service', {\n            action: 'identification',\n            content: { role: device['role'], status: 'connected', id: device['macAddress'] },\n            time: new Date()\n          });\n          socket.emit('message', { event: \"first server message\" });\n          if (slaves) {\n            socket.emit('service', {\n              action: 'slaveList',\n              content: Object.keys(slaves).map((value) => {\n                return { role: 'slave', status: 'connected', id: value }\n              }),\n              time: new Date()\n            });\n          }\n        });\n        socket.on('disconnect', () => {\n          linkDevice.disconnect((err) => {\n            if (err) {\n              console.log(err.message);\n              return logger.info(err.message);\n            }\n            console.log('device disconnected, can be unlocked');\n            logger.info('device disconnected, can be unlocked');\n          });\n        })\n      });\n    });\n\n    socket.on('test', (message) => {\n      console.log(message);\n      logger.info(message);\n    });\n\n    setTimeout(() => {\n      if (!socket.auth) {\n        console.log(`Disconnection socket: ${socket.id}`);\n        logger.info(`Disconnection socket: ${socket.id}`);\n        socket.disconnect('unauthorized');\n      }\n    }, 1000);\n\n    socket.on('disconnect', () => {\n      console.log(`a device: ${socket.id}, is disconnected`);\n      logger.info(`a device: ${socket.id}, is disconnected`);\n    })\n\n  });\n};\n\n"]}