{"version":3,"sources":["authenticate.es6"],"names":[],"mappings":"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","file":"authenticate.js","sourcesContent":["/**\n * Created by michaelsilvestre on 25/04/15\n */\n\nimport { adapters } from \"../adapters/absAdapter.js\"\nimport { LinkDevice, close } from \"../modules/message.js\"\nimport Authentication from \"../modules/authentication.js\"\nimport { logger } from \"../lib/logger.js\"\n\nimport _ from \"underscore\"\n\nexports.messageClose = close;\n\nclass ArrayStuff extends Array {\n  constructor() {\n    super();\n  }\n\n  // check if an element exists in array using a comparer function\n  // comparer : function(currentElement)\n  inArray(comparer) {\n    return !!this.filter(function(value) {\n      comparer(value);\n    }).length;\n  }\n\n  // adds an element to the array if it does not already exist using a comparer\n  // function\n  pushIfNotExist(element, comparer) {\n    if (!this.inArray(comparer)) {\n      this.push(element);\n      return true;\n    }\n    return false;\n  }\n}\n\nexport let authenticateInit = () => {\n  let socketList = new ArrayStuff();\n  let websocketAdapter = adapters.getAdapter(\"websocket\");\n\n  websocketAdapter.connection(function(socket) {\n    let device = null;\n    console.log(\"a device is connected\");\n    logger.info(\"a device is connected\");\n    socket.auth = false;\n    //socket.emit('event', \"first message\");\n\n    socket.on('authenticate', (data) => {\n      let authentication = new Authentication(data);\n      authentication.checkAuthToken((err, success) => {\n        if (err) {\n          return socket.emit('error_system', err.message);\n        }\n        if (!success) {\n          return;\n        }\n        device = success;\n        console.log(`Authenticated socket: ${socket.id}`);\n        logger.info(`Authenticated socket: ${socket.id}`);\n        socket.auth = true;\n\n        _.each(websocketAdapter.io.nsps, (nsp) => {\n          console.log(`restoring socket to: ${nsp.name}`);\n          logger.info(`restoring socket to: ${nsp.name}`);\n          nsp.connected[socket.id] = socket;\n        });\n\n        if (!socketList.pushIfNotExist({ id: socket.id, socket: socket }, (value) => {\n            return value.id === socket.id;\n          })) {\n          return socket.close();\n        }\n\n\n\n        let linkDevice = new LinkDevice(device, socket, (err, device, slaves) => {\n          if (err) {\n            console.warn(err);\n            logger.warn(err);\n            return;\n          }\n          socket.emit('authenticated');\n          socket.emit('service', {\n            action: 'identification',\n            content: { role: device['role'], status: 'connected', id: device['macAddress'] },\n            time: new Date()\n          });\n          socket.emit('message', { event: \"first server message\" });\n          if (slaves) {\n            socket.emit('service', {\n              action: 'slaveList',\n              content: Object.keys(slaves).map((value) => {\n                return { role: 'slave', status: 'connected', id: value }\n              }),\n              time: new Date()\n            });\n          }\n        });\n        socket.on('disconnect', () => {\n          linkDevice.disconnect((err) => {\n            if (err) {\n              console.log(err.message);\n              return logger.info(err.message);\n            }\n            console.log('device disconnected, can be unlocked');\n            logger.info('device disconnected, can be unlocked');\n          });\n        })\n      });\n    });\n\n    socket.on('test', (message) => {\n      console.log(message);\n      logger.info(message);\n    });\n\n    setTimeout(() => {\n      if (!socket.auth) {\n        console.log(`Disconnection socket: ${socket.id}`);\n        logger.info(`Disconnection socket: ${socket.id}`);\n        socket.disconnect('unauthorized');\n      }\n    }, 5000);\n\n    socket.on('disconnect', () => {\n      console.log(`a device: ${socket.id}, is disconnected`);\n      logger.info(`a device: ${socket.id}, is disconnected`);\n    })\n\n  });\n};\n\n"]}