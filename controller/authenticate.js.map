{
  "version": 3,
  "sources": [
    "authenticate.es6"
  ],
  "names": [],
  "mappings": "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",
  "file": "authenticate.js",
  "sourcesContent": [
    "/**\n * Created by michaelsilvestre on 25/04/15\n */\n\nimport { adapters } from \"../adapters/absAdapter.js\"\nimport { LinkDevice } from \"./message.js\"\nimport _ from \"underscore\"\nimport mongoose from \"mongoose\"\nimport getmac from \"getmac\"\n\nlet Application = mongoose.model('Application');\n\nexport let authenticateInit = () => {\n  let websocketAdapter = adapters.getAdapter(\"websocket\");\n  websocketAdapter.connection(function(socket) {\n    let device = null;\n    console.log(\"a device is connected\");\n    socket.auth = false;\n    //socket.emit('event', \"first message\");\n\n    socket.on('authenticate', (data) => {\n      let authenticate = new Authenticate(data);\n      authenticate.checkAuthToken((err, success) => {\n        if (err) {\n          return socket.emit('error', err);\n        }\n        if (!success) {\n          return;\n        }\n        device = success;\n        console.log(`Authenticated socket: ${socket.id}`);\n        socket.auth = true;\n\n        _.each(websocketAdapter.io.nsps, (nsp) => {\n          console.log(`restoring socket to: ${nsp.name}`);\n          nsp.connected[socket.id] = socket;\n        });\n\n\n        let linkDevice = new LinkDevice(device, socket, (err, queue) => {\n          if (err) {\n            return console.warn(err);\n          }\n          queue.emit('authenticated');\n          queue.emit('message', { event: \"first server message\" });\n        });\n        socket.on('disconnect', () => {\n          linkDevice.disconnect();\n        })\n      });\n    });\n\n    socket.on('test', (message) => {\n      console.log(message);\n    });\n\n    setTimeout(() => {\n      if (!socket.auth) {\n        console.log(`Disconnection socket: ${socket.id}`);\n        socket.disconnect('unauthorized');\n      }\n    }, 1000);\n\n    socket.on('disconnect', () => {\n      console.log(\"a device is disconnected\");\n    })\n\n  });\n};\n\nclass Authenticate {\n  constructor(data) {\n    if (!data) {\n      return null;\n    }\n    this._data = JSON.parse(data);\n  }\n\n  checkAuthToken(callback) {\n\n    if (!this._data.hasOwnProperty('applicationId')) {\n      return callback(new Error(\"Missing applicationId for the authentification\"), null);\n    }\n\n    if (!this._data.hasOwnProperty('key')) {\n      return callback(new Error(\"Missing key for the authentification\"), null);\n    }\n\n    if (!this._data.hasOwnProperty('password')) {\n      return callback(new Error(\"Missing password for the authentification\"), null);\n    }\n\n    if (!this._data.hasOwnProperty('macAddress')) {\n      return callback(new Error(\"Missing macAddress for the authentification\"), null);\n    }\n\n    if (!_.isString(this._data['key'])) {\n      return callback(new Error(\"Key should be a string\"), null);\n    }\n\n    if (this._data['key'].length !== 40) {\n      return callback(new Error(\"Key has not the good size\"), null);\n    }\n\n    if (!_.isString(this._data['password'])) {\n      return callback(new Error(\"Password should be a string\"), null);\n    }\n\n    if (this._data['password'].length !== 80) {\n      return callback(new Error(\"Password has not the good size\"), null);\n    }\n\n    if (!_.isNumber(this._data['applicationId'])) {\n      return callback(new Error(\"ApplicationId should be a number\"), null);\n    }\n\n    if (!getmac.isMac(this._data['macAddress'])) {\n      return callback(new Error(\"The mac address is not correctly formated\"), null);\n    }\n\n    Application.authenticate(this._data, (err, result) => {\n      if (err) {\n        return callback(err, null);\n      }\n      if (!result) {\n        return callback(new Error(\"The applicationId are not correct\"), null);\n      }\n      if (result.role === \"\") {\n        return callback(new Error(\"The key and password are not correct\"), null);\n      }\n      console.log(result);\n      return callback(null, result);\n    });\n  }\n}"
  ]
}