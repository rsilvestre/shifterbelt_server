{
  "version": 3,
  "sources": [
    "/Users/michaelsilvestre/git/shifterbelt/beta/models/application.es6"
  ],
  "names": [],
  "mappings": "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",
  "file": "application.js",
  "sourcesContent": [
    "/**\n * Created by michaelsilvestre on 23/04/15\n */\n\n/**\n * Module dependencies.\n */\n\nimport mongoose from 'mongoose';\nimport crypto from 'crypto';\nimport token from 'token';\n\ntoken.defaults.secret = 'uj1k9iEq7LYNCFlLU0AZS2MEfYKGVVif8OpPBNc1';\ntoken.defaults.timeStep = 24 * 60 * 60; // 24h in seconds\n\nlet Schema = mongoose.Schema;\n\nlet makeSalt = function() {\n  return Math.round((new Date().valueOf() * Math.random())) + '';\n};\n\nlet encryptPassword = function(password) {\n  if (!password) return '';\n  try {\n    return crypto\n      .createHmac('sha1', this.salt)\n      .update(password)\n      .digest('hex');\n  } catch (err) {\n    return '';\n  }\n};\n\nlet Generator = function(preSave) {\n\n  if (false === (this instanceof Generator)) {\n    return new Generator(preSave);\n  }\n\n  let Application = mongoose.model('Application');\n\n  this.businessId = function(cb) {\n    let businessId = makeSalt();\n    Application.find({ 'businessId': businessId })\n      .select('businessId')\n      .exec(function(err, result) {\n        if (err) return cb(err);\n\n        if (result.length > 0) {\n          return generate(cb);\n        }\n        preSave.businessId = businessId;\n        cb();\n      });\n  };\n\n  this.keys = function(cb) {\n    \"use strict\";\n\n    let keyGen = function(type) {\n      return {\n        role: type,\n        key: crypto.createHmac('sha1', Math.random().toString()).update((new Date()).valueOf().toString()).digest('hex').substring(0, 40),\n        passwd: token.generate((new Date()).valueOf().toString() + '|' + Math.random().toString()).substring(0, 80)\n      }\n    };\n    preSave.keys.push(new keyGen(\"master\"));\n    preSave.keys.push(new keyGen(\"manager\"));\n    preSave.keys.push(new keyGen(\"slave\"));\n    cb();\n  }\n\n};\n/**\n * Getter\n */\n\nlet getBusinessId = function(businessId) {\n  \"use strict\";\n  return businessId;\n};\n\n/**\n * Setter\n */\n\nlet setBusinessId = function(businessId) {\n  \"use strict\";\n  if (this.isNew) {\n    return businessId;\n  }\n  return this.businessId;\n};\n\n/**\n * Application Schema\n */\n\nlet ApplicationSchema = new Schema({\n  name: { type: String, required: true, trim: true, index: true, unique: \"Name cannot be blank\" },\n  businessId: { type: String, index: true, unique: true },\n  strategy: { type: String, required: 'The strategy has not been defined', enum: ['direct', 'work'] },\n  users: [{\n    user: { type: Schema.ObjectId, ref: 'User', required: true },\n    role: { type: String, required: true, enum: [\"owner\", \"manager\", \"invited\"] }\n  }],\n  createdAt: { type: Date, default: Date.now },\n  keys: [{\n    role: { type: String, required: true, enum: [\"master\", \"manager\", \"slave\"] },\n    key: { type: String, required: true },\n    passwd: { type: String, required: true }\n  }]\n});\n\n/**\n * Virtuals\n */\n\n\n/**\n * Validations\n */\n\n/**\n * Pre-save hook\n */\n\nApplicationSchema.pre('save', function(next) {\n  \"use strict\";\n\n  if (!this.isNew) {\n    return next();\n  }\n\n\n  let generator = new Generator(this);\n\n  generator.businessId(function() {\n    generator.keys(next);\n  });\n\n\n});\n\n/**\n * Methods\n */\n\nApplicationSchema.methods = {\n  addUser: function(user, role, cb) {\n    \"use strict\";\n    let notify = require('../mailer');\n    this.users.push({\n      user: user._id,\n      role: role\n    });\n\n    notify.createApplication({\n      application: this,\n      currentUser: user\n    });\n\n    this.save(cb);\n  }, /**\n   * Authenticate - check if the passwords are the same\n   *\n   * @param {String} plainText\n   * @return {Boolean}\n   * @api public\n   */\n\n  authenticate: function(plainText) {\n    return this.encryptPassword(plainText) === this.hashed_password;\n  },\n\n  /**\n   * Make salt\n   *\n   * @return {String}\n   * @api public\n   */\n\n  makeSalt: makeSalt,\n\n  /**\n   * Encrypt password\n   *\n   * @param {String} password\n   * @return {String}\n   * @api public\n   */\n\n  encryptPassword: encryptPassword\n};\n\n/**\n * Statics\n */\nApplicationSchema.statics = {\n  /**\n   *\n   * @param id\n   * @param cb\n   * @api public\n   */\n  load: function(id, user, cb) {\n    \"use strict\";\n    this.findOne({ businessId: id })\n      .populate('users.user', 'name email username')\n      .exec(cb);\n  },\n\n  list: function(options, cb) {\n    \"use strict\";\n\n    let criteria = options.criteria || {};\n\n    this.find(criteria)\n      .populate('users.user', 'name email username')\n      .exec(cb);\n  },\n\n  /**\n   *\n   * @param businessId\n   * @param cb\n   * @api public\n   */\n  selectByBusinessId: function(businessId, cb) {\n    \"use strict\";\n    this.findOne({ businessId: businessId })\n      .populate('users.user', 'name email username')\n      .select('name')\n      .exec(cb);\n  },\n\n  /**\n   *\n   * @param businessId\n   * @param cb\n   * @api public\n   */\n  authenticate: function(data, cb) {\n    \"use strict\";\n    this.findOne({ businessId: data.applicationId })\n      .exec((err, result) => {\n        if (err) {\n          return cb(err);\n        }\n        if (!result) {\n          return cb(new Error(\"There is no result\"));\n        }\n        let keys = result.keys.filter((value) => {\n          return value.key === data.key && value.passwd === data.password\n        });\n        cb(null, {\n          applicationId: result._id,\n          strategy: result.strategy,\n          role: keys[0].role || \"\"\n        });\n      });\n  }\n};\n\n//mongoose.model('Application', ApplicationSchema);\nexport let Application = mongoose.model('Application', ApplicationSchema);\n\n\n//import mongoose from \"mongoose\";\n//\n//let applicationSchema = new mongoose.Schema({\n//  name: { type: String, required: true, unique: true },\n//  businessId: { type: String, required: true, unique: true },\n//  users: [{\n//    userId: { type: mongoose.Schema.Types.ObjectId, ref: 'User', required: true },\n//    role: { type: String, required: true, enum: [\"owner\", \"manager\", \"invited\"] }\n//  }],\n//  createdAt: { type: Date, default: Date.now },\n//  keys: [{\n//    role: { type: String, required: true, enum: [\"master\", \"manager\", \"slave\"] },\n//    key: { type: String, required: true },\n//    passwd: { type: String, required: true }\n//  }]\n//});\n//\n//applicationSchema.index({ name: 1 });\n//\n//applicationSchema.statics.selectApplicationByName = function(name, callback) {\n//  return this.findOne({ name: name }, callback);\n//};\n//\n//applicationSchema.statics.selectAll = function(callback) {\n//  return this.find({}, callback);\n//};\n//\n//export let Application = mongoose.model('Application', applicationSchema);\n//\n//Application.schema.path('name').validate((value) => {\n//  return (value.length >= 4 && value.length <= 20);\n//}, \"The size of the field should be between 4 and 20 characters\");\n//\n//Application.schema.path('keys').validate((value) => {\n//  return value.length < 3;\n//}, 'Invalid number of Keys is less than 3');\n//\n//Application.schema.path('users').validate((value) => {\n//  return value.length < 1;\n//}, \"Invalid users list. Should be at least 1 user\");\n\n\n\n"
  ]
}