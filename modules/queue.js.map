{"version":3,"sources":["queue.es6"],"names":[],"mappings":";;;;;;;;;;;;;;oBAIoB,MAAM;;IAEL,KAAK;;;;;;;AAMb,WANQ,KAAK,CAMZ,YAAY,EAAE,MAAM,EAAE;0BANf,KAAK;;AAOtB,QAAI,CAAC,aAAa,GAAG,YAAY,CAAC;AAClC,QAAI,CAAC,OAAO,GAAG,MAAM,CAAC;AACtB,QAAI,CAAC,IAAI,GAAG,IAAI,CAAC;GAClB;;eAVkB,KAAK;;;;;;;;;;WAmBnB,eAAC,KAAK,EAAE,OAAO,EAAE,IAAI,EAAE;AACxB,UAAI,SAAS,KAAK,IAAI,CAAC,IAAI,EAAE;AAC3B,eAAO,IAAI,CAAC,aAAa,CAAC,KAAK,CAAC,WAAW,CAAC,IAAI,CAAC,IAAI,CAAC,KAAK,OAAK,IAAI,CAAC,OAAO,SAAI,KAAK,EAAI,OAAO,CAAC,CAAC,IAAI,CAAC,YAAM;AAC3G,iBAAO,IAAI,EAAE,CAAC;SACf,CAAC,CAAC;OACJ;KACJ;;;;;;;;;;;WASe,0BAAC,KAAK,EAAE,UAAU,EAAE,IAAI,EAAE;;;AACxC,UAAI,EAAE,GAAG,IAAI,CAAC,aAAa,CAAC,KAAK,CAAC,cAAc,MAAI,IAAI,CAAC,OAAO,SAAI,KAAK,EAAI,QAAQ,EAAE,EAAE,OAAO,EAAE,KAAK,EAAE,CAAC,CAAC;;AAE3G,QAAE,GAAG,EAAE,CAAC,IAAI,CAAC,YAAM;AACjB,eAAO,MAAK,aAAa,CAAC,KAAK,CAAC,WAAW,CAAC,EAAE,EAAE,EAAE,SAAS,EAAE,IAAI,EAAE,CAAC,CAAC;OACtE,CAAC,CAAC;;AAEH,QAAE,GAAG,EAAE,CAAC,IAAI,CAAC,UAAC,GAAG,EAAK;AACpB,cAAK,IAAI,GAAG,GAAG,CAAC;AAChB,eAAO,MAAK,aAAa,CAAC,KAAK,CAAC,SAAS,CAAC,GAAG,CAAC,KAAK,OAAK,MAAK,OAAO,SAAI,KAAK,EAAI,EAAE,CAAC,CAAC,IAAI,CAAC,YAAM;AAC9F,iBAAO,GAAG,CAAC,KAAK,CAAC;SAClB,CAAC,CAAC;OACJ,CAAC,CAAC;;AAEH,QAAE,GAAG,EAAE,CAAC,IAAI,CAAC,UAAC,CAAC,EAAK;AAClB,eAAO,MAAK,aAAa,CAAC,KAAK,CAAC,OAAO,CAAC,CAAC,EAAE,UAAU,EAAE,EAAE,KAAK,EAAE,IAAI,EAAE,CAAC,CAAC;OACzE,CAAC,CAAC;;AAEH,QAAE,GAAG,EAAE,CAAC,IAAI,CAAC,YAAM;AACjB,eAAO,CAAC,GAAG,CAAC,0BAA0B,CAAC,CAAC;AACxC,YAAI,IAAI,EAAE;AACR,cAAI,EAAE,CAAC;SACR;OACF,CAAC,CAAC;;AAEH,aAAO,EAAE,CAAC;KACX;;;;;;;;;;;WASkB,6BAAC,KAAK,EAAE,UAAU,EAAE,IAAI,EAAE;;;AAC3C,UAAI,EAAE,GAAG,IAAI,CAAC,aAAa,CAAC,KAAK,CAAC,WAAW,MAAI,IAAI,CAAC,OAAO,SAAI,KAAK,EAAI,EAAE,OAAO,EAAE,IAAI,EAAE,CAAC,CAAC;AAC7F,QAAE,GAAG,EAAE,CAAC,IAAI,CAAC,YAAM;AACjB,eAAK,aAAa,CAAC,KAAK,CAAC,QAAQ,CAAC,CAAC,CAAC,CAAC;OACtC,CAAC,CAAC;AACH,QAAE,GAAG,EAAE,CAAC,IAAI,CAAC,YAAM;AACjB,eAAO,OAAK,aAAa,CAAC,KAAK,CAAC,OAAO,MAAI,OAAK,OAAO,SAAI,KAAK,EAAI,UAAU,EAAE,EAAE,KAAK,EAAE,KAAK,EAAE,CAAC,CAAC;OACnG,CAAC,CAAC;AACH,QAAE,GAAG,EAAE,CAAC,IAAI,CAAC,YAAM;AACjB,eAAO,CAAC,GAAG,CAAC,iDAAiD,CAAC,CAAC;AAC/D,YAAI,IAAI,EAAE;AACR,cAAI,EAAE,CAAC;SACR;OACF,CAAC,CAAC;;AAEH,aAAO,EAAE,CAAC;KACX;;;;;;;;;;;;WAUiB,4BAAC,KAAK,EAAE,IAAI,EAAE,UAAU,EAAE,IAAI,EAAE;;;AAChD,UAAI,EAAE,GAAG,IAAI,CAAC,aAAa,CAAC,KAAK,CAAC,cAAc,MAAI,IAAI,CAAC,OAAO,SAAI,KAAK,EAAI,OAAO,EAAE,EAAE,OAAO,EAAE,KAAK,EAAE,CAAC,CAAC;;AAE1G,QAAE,GAAG,EAAE,CAAC,IAAI,CAAC,YAAM;AACjB,eAAO,OAAK,aAAa,CAAC,KAAK,CAAC,WAAW,CAAC,EAAE,EAAE,EAAE,SAAS,EAAE,IAAI,EAAE,CAAC,CAAC;OACtE,CAAC,CAAC;;AAEH,QAAE,GAAG,EAAE,CAAC,IAAI,CAAC,UAAC,GAAG,EAAK;AACpB,eAAK,IAAI,GAAG,GAAG,CAAC;AAChB,YAAI,CAAC,GAAG,GAAG,CAAC,KAAK,CAAC;AAClB,eAAO,UA3GJ,GAAG,EA2GK,IAAI,CAAC,GAAG,CAAC,UAAC,EAAE,EAAK;AAC1B,iBAAK,aAAa,CAAC,KAAK,CAAC,SAAS,CAAC,CAAC,OAAK,OAAK,OAAO,SAAI,KAAK,EAAI,EAAE,CAAC,CAAC;SACvE,CAAC,CAAC,CAAC,IAAI,CAAC,YAAM;AACb,iBAAO,CAAC,CAAC;SACV,CAAC,CAAC;OACJ,CAAC,CAAC;;AAEH,QAAE,GAAG,EAAE,CAAC,IAAI,CAAC,UAAC,CAAC,EAAK;AAClB,eAAO,OAAK,aAAa,CAAC,KAAK,CAAC,OAAO,CAAC,CAAC,EAAE,UAAU,EAAE,EAAE,KAAK,EAAE,IAAI,EAAE,CAAC,CAAC;OACzE,CAAC,CAAC;;AAEH,QAAE,GAAG,EAAE,CAAC,IAAI,CAAC,YAAM;AACjB,eAAO,CAAC,GAAG,CAAC,8CAA8C,CAAC,CAAC;AAC5D,YAAI,IAAI,EAAE;AACR,cAAI,EAAE,CAAC;SACR;OACF,CAAC,CAAC;;AAEH,aAAO,EAAE,CAAC;KACX;;;;;;;;;;WAQe,0BAAC,KAAK,EAAE,IAAI,EAAE;;;AAC5B,aAAO,CAAC,GAAG,YAAU,IAAI,CAAC,OAAO,CAAG,CAAC;AACrC,UAAI,EAAE,GAAG,IAAI,CAAC,aAAa,CAAC,KAAK,CAAC,cAAc,MAAI,IAAI,CAAC,OAAO,SAAI,KAAK,EAAI,QAAQ,EAAE,EAAE,OAAO,EAAE,KAAK,EAAE,CAAC,CAAC;;AAE3G,QAAE,GAAG,EAAE,CAAC,IAAI,CAAC,YAAM;AACjB,YAAI,CAAC,UAAC,OAAO,EAAE,QAAQ,EAAK;AAC1B,iBAAK,aAAa,CAAC,KAAK,CAAC,OAAO,MAAI,OAAK,OAAO,SAAI,KAAK,EAAI,EAAE,EAAE,IAAI,MAAM,CAAC,OAAO,CAAC,CAAC,CAAC;AACtF,iBAAO,CAAC,GAAG,CAAC,kBAAgB,EAAE,OAAO,CAAC,CAAC;AACvC,cAAI,QAAQ,EAAE;AACZ,oBAAQ,EAAE,CAAC;WACZ;SACF,CAAC,CAAC;OACJ,CAAC,CAAC;;AAEH,aAAO,EAAE,CAAC;KACX;;;;;;;;;;WAQgB,2BAAC,KAAK,EAAE,IAAI,EAAE;;;AAC7B,aAAO,CAAC,GAAG,YAAU,IAAI,CAAC,OAAO,CAAG,CAAC;AACrC,UAAI,EAAE,GAAG,IAAI,CAAC,aAAa,CAAC,WAAW,MAAI,IAAI,CAAC,OAAO,SAAI,KAAK,EAAI,EAAE,OAAO,EAAE,IAAI,EAAE,CAAC,CAAC;;AAEvF,QAAE,GAAG,EAAE,CAAC,IAAI,CAAC,YAAM;AACjB,YAAI,CAAC,UAAC,OAAO,EAAE,QAAQ,EAAK;AAC1B,iBAAK,aAAa,CAAC,KAAK,CAAC,WAAW,MAAI,OAAK,OAAO,SAAI,KAAK,EAAI,IAAI,MAAM,CAAC,OAAO,CAAC,EAAE,EAAE,YAAY,EAAE,IAAI,EAAE,CAAC,CAAC;AAC9G,iBAAO,CAAC,GAAG,CAAC,kBAAgB,EAAE,OAAO,CAAC,CAAC;AACvC,cAAI,QAAQ,EAAE;AACZ,oBAAQ,EAAE,CAAC;WACZ;SACF,CAAC,CAAC;OACJ,CAAC,CAAC;;AAEH,aAAO,EAAE,CAAC;KACX;;;;;;;;;;WAQoB,+BAAC,KAAK,EAAE,IAAI,EAAE;;;AACjC,UAAI,EAAE,GAAG,IAAI,CAAC,aAAa,CAAC,KAAK,CAAC,cAAc,MAAI,IAAI,CAAC,OAAO,SAAI,KAAK,EAAI,OAAO,EAAE,EAAE,OAAO,EAAE,KAAK,EAAE,CAAC,CAAC;AAC1G,QAAE,GAAG,EAAE,CAAC,IAAI,CAAC,YAAM;AACjB,YAAI,CAAC,UAAC,OAAO,EAAE,GAAG,EAAE,QAAQ,EAAK;AAC/B,iBAAK,aAAa,CAAC,KAAK,CAAC,OAAO,MAAI,OAAK,OAAO,SAAI,KAAK,EAAI,GAAG,EAAE,IAAI,MAAM,CAAC,OAAO,CAAC,CAAC,CAAC;AACvF,iBAAO,CAAC,GAAG,CAAC,qBAAmB,EAAE,GAAG,EAAE,OAAO,CAAC,CAAC;AAC/C,cAAI,QAAQ,EAAE;AACZ,oBAAQ,EAAE,CAAC;WACZ;SACF,CAAC,CAAC;OACJ,CAAC,CAAC;;AAEH,aAAO,EAAE,CAAC;KACX;;;SA/LkB,KAAK;;;qBAAL,KAAK","file":"queue.js","sourcesContent":["/**\n * Created by michaelsilvestre on 29/05/15\n */\n\nimport { all } from \"when\"\n\nexport default class Queue {\n  /**\n   *\n   * @param {Object} queueAdapter\n   * @param {String} essaim\n   */\n  constructor(queueAdapter, essaim) {\n    this._queueAdapter = queueAdapter;\n    this._essaim = essaim;\n    this._qok = null;\n  }\n\n  /**\n   *\n   * @param {String} queue\n   * @param {String} pattern\n   * @param {Function} next\n   * @returns {Promise|Promise.<T>|*}\n   */\n  close(queue, pattern, next) {\n      if (undefined !== this._qok) {\n        return this._queueAdapter.chSub.unbindQueue(this._qok.queue, `${this._essaim}|${queue}`, pattern).then(() => {\n          return next();\n        });\n      }\n  }\n\n  /**\n   *\n   * @param {String} queue\n   * @param {Function} subMessage\n   * @param {Function} next\n   * @returns {{exchange}|{exchange, ticket, type, passive, durable, autoDelete, internal, nowait, arguments}}\n   */\n  registerSubQueue(queue, subMessage, next) {\n    let ok = this._queueAdapter.chSub.assertExchange(`${this._essaim}|${queue}`, 'fanout', { durable: false });\n\n    ok = ok.then(() => {\n      return this._queueAdapter.chSub.assertQueue('', { exclusive: true });\n    });\n\n    ok = ok.then((qok) => {\n      this._qok = qok;\n      return this._queueAdapter.chSub.bindQueue(qok.queue, `${this._essaim}|${queue}`, '').then(() => {\n        return qok.queue;\n      });\n    });\n\n    ok = ok.then((q) => {\n      return this._queueAdapter.chSub.consume(q, subMessage, { noAck: true });\n    });\n\n    ok = ok.then(() => {\n      console.log(' [*] Waiting for message');\n      if (next) {\n        next();\n      }\n    });\n\n    return ok;\n  }\n\n   /**\n   *\n   * @param {String} queue\n   * @param {Function} subMessage\n   * @param {Function} next\n   * @returns {{queue, exclusive, durable, autoDelete, arguments, passive, ticket, nowait}}\n   */\n  registerWorkerQueue(queue, subMessage, next) {\n    let ok = this._queueAdapter.chSub.assertQueue(`${this._essaim}|${queue}`, { durable: true });\n    ok = ok.then(() => {\n      this._queueAdapter.chSub.prefetch(1);\n    });\n    ok = ok.then(() => {\n      return this._queueAdapter.chSub.consume(`${this._essaim}|${queue}`, subMessage, { noAck: false });\n    });\n    ok = ok.then(() => {\n      console.log(\" [*] Waiting for messages. To exit press CTRL+C\");\n      if (next) {\n        next();\n      }\n    });\n\n    return ok;\n  }\n\n  /**\n   *\n   * @param {String} queue\n   * @param {String} keys\n   * @param {Function} subMessage\n   * @param {Function} next\n   * @returns {{exchange}|{exchange, ticket, type, passive, durable, autoDelete, internal, nowait, arguments}}\n   */\n  registerTopicQueue(queue, keys, subMessage, next) {\n    var ok = this._queueAdapter.chSub.assertExchange(`${this._essaim}|${queue}`, 'topic', { durable: false });\n\n    ok = ok.then(() => {\n      return this._queueAdapter.chSub.assertQueue('', { exclusive: true });\n    });\n\n    ok = ok.then((qok) => {\n      this._qok = qok;\n      var q = qok.queue;\n      return all(keys.map((rk) => {\n        this._queueAdapter.chSub.bindQueue(q, `${this._essaim}|${queue}`, rk);\n      })).then(() => {\n        return q;\n      });\n    });\n\n    ok = ok.then((q) => {\n      return this._queueAdapter.chSub.consume(q, subMessage, { noAck: true });\n    });\n\n    ok = ok.then(() => {\n      console.log(' [*] Waiting for logs. To exit press CTRL+C.');\n      if (next) {\n        next();\n      }\n    });\n\n    return ok;\n  }\n\n  /**\n   *\n   * @param {String} queue\n   * @param {Function} next\n   * @returns {{exchange}|{exchange, ticket, type, passive, durable, autoDelete, internal, nowait, arguments}}\n   */\n  registerPubQueue(queue, next) {\n    console.log(`queue ${this._essaim}`);\n    let ok = this._queueAdapter.chPub.assertExchange(`${this._essaim}|${queue}`, 'fanout', { durable: false });\n\n    ok = ok.then(() => {\n      next((message, callback) => {\n        this._queueAdapter.chPub.publish(`${this._essaim}|${queue}`, '', new Buffer(message));\n        console.log(\" [x] Sent '%s'\", message);\n        if (callback) {\n          callback();\n        }\n      });\n    });\n\n    return ok;\n  }\n\n  /**\n   *\n   * @param {String} queue\n   * @param {Function} next\n   * @returns {{exchange}|{exchange, ticket, type, passive, durable, autoDelete, internal, nowait, arguments}}\n   */\n  registerTaskQueue(queue, next) {\n    console.log(`queue ${this._essaim}`);\n    var ok = this._queueAdapter.assertQueue(`${this._essaim}|${queue}`, { durable: true });\n\n    ok = ok.then(() => {\n      next((message, callback) => {\n        this._queueAdapter.chPub.sendToQueue(`${this._essaim}|${queue}`, new Buffer(message), { deliveryMode: true });\n        console.log(\" [x] Sent '%s'\", message);\n        if (callback) {\n          callback();\n        }\n      });\n    });\n\n    return ok;\n  }\n\n  /**\n   *\n   * @param {String} queue\n   * @param {Function} next\n   * @returns {{exchange}|{exchange, ticket, type, passive, durable, autoDelete, internal, nowait, arguments}}\n   */\n  registerSelectorQueue(queue, next) {\n    var ok = this._queueAdapter.chPub.assertExchange(`${this._essaim}|${queue}`, 'topic', { durable: false });\n    ok = ok.then(() => {\n      next((message, key, callback) => {\n        this._queueAdapter.chPub.publish(`${this._essaim}|${queue}`, key, new Buffer(message));\n        console.log(\" [x] Sent %s:'%s'\", key, message);\n        if (callback) {\n          callback();\n        }\n      });\n    });\n\n    return ok;\n  }\n}\n"]}