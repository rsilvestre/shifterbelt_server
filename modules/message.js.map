{"version":3,"sources":["message.es6"],"names":[],"mappings":"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","file":"message.js","sourcesContent":["/**\n * Created by michaelsilvestre on 19/05/15\n */\n\nimport { adapters } from \"../adapters/absAdapter.js\";\nimport Queue from '../modules/queue.js'\nimport _ from \"underscore\";\nimport { logger } from \"../lib/logger.js\"\n\nlet devicesContainer = {\n  masters: {},\n  managers: {},\n  slaves: {}\n};\n\nexport class LinkDevice {\n  /**\n   *\n   * @param {Object} data\n   * @param {socket.io} socket\n   * @param {Function} callback\n   */\n  constructor(data, socket, callback) {\n    this._queue = new Queue(adapters.getAdapter('queue'), data['application']['businessId']);\n    this._socket = socket;\n    this._data = data;\n    this._send = null;\n    let action = `register${data['device']['role'].charAt(0).toUpperCase()}${data['device']['role'].slice(1)}`;\n    console.log(`action: ${action}`);\n    logger.info(`action: ${action}`);\n\n    //if (!this.hasOwnProperty(action)) {\n    //  throw new Error(`The property: ${action}, not exist`);\n    //}\n    try {\n      this[action](data, socket, callback);\n    } catch (e) {\n      console.warn(new Error(`The property: ${action}, not exist: ${e}`));\n    }\n  }\n\n  /**\n   *\n   * @param {Object} data\n   * @param {Function} next\n   */\n  createIfNotExistListDevices(data, next) {\n    if (!devicesContainer.hasOwnProperty(`${data.device.role}s`)) {\n      return next(new Error(`The container don't contain a object: ${data.device.role}s`));\n    }\n    if (!devicesContainer[`${data.device.role}s`].hasOwnProperty(`${data['application']['businessId']}`)) {\n      devicesContainer[`${data.device.role}s`][`${data['application']['businessId']}`] = {};\n      return next();\n    }\n    if (devicesContainer[`${data.device.role}s`][data['application']['businessId']].hasOwnProperty(data['device']['macAddress'])) {\n      return next(new Error(`The queue: ${data['device']['role']}, still contain a key: ${data['device']['macAddress']}`));\n    }\n    next();\n  }\n\n  /**\n   *\n   * @param {Object} data\n   * @returns {Object}\n   */\n  createFakeList(data) {\n    let fakeList = {};\n    fakeList[`${data['application']['businessId']}`] = {};\n    fakeList[`${data['application']['businessId']}`][`${data['device']['macAddress']}`] = this;\n\n    return fakeList;\n  }\n\n  /**\n   *\n   * @param {Object} data\n   * @param {socket.io} socket\n   * @param {Function} next\n   */\n  registerMaster(data, socket, next) {\n    this.createIfNotExistListDevices(data, (err) => {\n      if (err) {\n        return next(err);\n      }\n\n      devicesContainer.masters[`${data['application']['businessId']}`][`${data['device']['macAddress']}`] = this;\n\n      this.createSubQueue(`pubsub`, data['application']['businessId'], this.createFakeList(data), () => {\n        console.log(`${data['device']['macAddress']} has been added to the SubPub queue of the essaim ${data['application']['businessId']}`);\n        logger.info(`${data['device']['macAddress']} has been added to the SubPub queue of the essaim ${data['application']['businessId']}`);\n        this._queue.registerSelectorQueue(`topic`, (callback) => {\n          this._send = callback;\n          socket.on('message', (chunk) => {\n            let { key, message } = JSON.parse(chunk);\n            if (message) {\n              return callback(message, key);\n            }\n            return callback(chunk);\n          });\n          next(null, data['device'], devicesContainer.slaves[`${data['application']['businessId']}`] || {});\n        });\n      });\n\n    });\n\n  }\n\n  /**\n   *\n   * @param {Object} data\n   * @param {socket.io} socket\n   * @param {Function} next\n   */\n  registerManager(data, socket, next) {\n    this.createIfNotExistListDevices(data, (err) => {\n      if (err) {\n        return next(err);\n      }\n\n      devicesContainer.managers[`${data['application']['businessId']}`][`${data['device']['macAddress']}`] = this;\n\n      this.createSubQueue(`pubsub`, data['application']['businessId'], this.createFakeList(data), () => {\n        console.log(`${data['device']['macAddress']} has been added to the SubPub queue of the essaim ${data['application']['businessId']}`);\n        logger.info(`${data['device']['macAddress']} has been added to the SubPub queue of the essaim ${data['application']['businessId']}`);\n        this._queue.registerSelectorQueue(`topic`, (callback) => {\n          this._send = callback;\n          socket.on('message', (chunk) => {\n            let { key, message } = JSON.parse(chunk);\n            if (message) {\n              return callback(message, key);\n            }\n            return callback(chunk);\n          });\n          next(null, data['device'], devicesContainer.slaves[`${data['application']['businessId']}`] || {});\n        });\n      });\n    });\n  }\n\n  /**\n   *\n   * @param {Object} data\n   * @param {socket.io} socket\n   * @param {Function} next\n   */\n  registerSlave(data, socket, next) {\n    this.createIfNotExistListDevices(data, (err) => {\n      if (err) {\n        return next(err);\n      }\n\n      devicesContainer.slaves[`${data['application']['businessId']}`][`${data['device']['macAddress']}`] = this;\n\n      this.createTopicQueue(`topic`, data['application']['businessId'], data['device']['macAddress'], this.createFakeList(data), () => {\n        console.log(`${data['device']['macAddress']} has been added to the Topic queue of the essaim ${data['application']['businessId']}`);\n        logger.info(`${data['device']['macAddress']} has been added to the Topic queue of the essaim ${data['application']['businessId']}`);\n        this._queue.registerPubQueue(`pubsub`, (callback) => {\n          this._send = callback;\n          callback(JSON.stringify({\n            type: 'service', message: {\n              action: 'connection',\n              content: { role: 'slave', status: 'connected', id: data['device']['macAddress'] },\n              time: new Date()\n            }\n          }));\n          socket.on('message', (message) => {\n            let messageObj = JSON.parse(message);\n            messageObj.slaveId = data['device']['macAddress'];\n            callback(JSON.stringify(messageObj));\n          });\n          next(null, data['device']);\n        });\n      });\n\n    });\n  }\n\n  /**\n   *\n   * @param {String} queue\n   * @param {String} essaim\n   * @param {Object} list\n   * @param {Function} next\n   */\n  createSubQueue(queue, essaim, list, next) {\n    let keys = Object.keys(list[essaim] || {})\n      , numKey = keys.length;\n\n    if (keys.length < 1) {\n      return next();\n    }\n\n    keys.forEach((key) => {\n      this._queue.registerSubQueue(queue, (message) => {\n        if (!message) {\n          return;\n        }\n        console.log('subQueue message: ' + message.content.toString());\n        logger.info('subQueue message: ' + message.content.toString());\n        let {type: type, message: msg} = JSON.parse(message.content.toString());\n        if (!type) {\n          return list[essaim][key].socket.emit('message', message);\n        }\n        list[essaim][key].socket.emit(type, msg);\n      }, () => {\n        if (--numKey === 0) {\n          next();\n        }\n      });\n    });\n  }\n\n  /**\n   *\n   * @param {string} queue\n   * @param {String} essaim\n   * @param {String} deviceId\n   * @param {Object} list\n   * @param {Function} next\n   */\n  createTopicQueue(queue, essaim, deviceId, list, next) {\n    let keys = Object.keys(list[essaim] || {})\n      , numKey = keys.length;\n\n    if (keys.length < 1) {\n      return next();\n    }\n\n    keys.forEach((key) => {\n      this._queue.registerTopicQueue(queue, [\"broadcast\", deviceId], (message) => {\n        if (!message) {\n          return;\n        }\n        console.log('topicQueue message: ' + message.content.toString());\n        logger.info('topicQueue message: ' + message.content.toString());\n        list[essaim][key].socket.emit('message', message);\n      }, () => {\n        if (--numKey === 0) {\n          next();\n        }\n      });\n    });\n  }\n\n  /**\n   *\n   * @returns {*|LinkDevice.socket}\n   */\n  get socket() {\n    return this._socket;\n  }\n\n  /**\n   *\n   * @param {*|Function} done\n   */\n  disconnect(done) {\n    let action = `disconnectFrom${this._data['device']['role'].charAt(0).toUpperCase()}${this._data['device']['role'].slice(1)}`;\n    console.log(`action: ${action}`);\n    logger.info(`action: ${action}`);\n\n    //if (!this.hasOwnProperty(action)) {\n    //  throw new Error(`The property: ${action}, not exist`);\n    //}\n    try {\n      this[action](done);\n    } catch (e) {\n      console.warn(new Error(`The property: ${action}, not exist: ${e}`));\n    }\n  }\n\n  /**\n   *\n   * @param {Function} done\n   * @returns {*}\n   */\n  deleteDevice(done) {\n    done = \"function\" === typeof done ? done : (value) => {\n      return value;\n    };\n    if (!devicesContainer.hasOwnProperty(`${this._data.device.role}s`)) {\n      throw new Error(`The deviceContainer don't contain a container: ${this._data.device.role}s`);\n    }\n    if (!devicesContainer[`${this._data.device.role}s`][this._data['application']['businessId']] || !devicesContainer[`${this._data.device.role}s`][this._data['application']['businessId']][this._data['device']['macAddress']]) {\n      return done(new Error('Nothing to do'));\n    }\n    delete(devicesContainer[`${this._data.device.role}s`][this._data['application']['businessId']][this._data['device']['macAddress']]);\n    console.log(`device: ${[this._data['device']['macAddress']]}, has been removed from: ${this._data['application']['businessId']}`);\n    logger.info(`device: ${[this._data['device']['macAddress']]}, has been removed from: ${this._data['application']['businessId']}`);\n    return done();\n  }\n\n  /**\n   *\n   * @param {Function} done\n   */\n  disconnectFromMaster(done) {\n    this._queue.close(`pubsub`, '', () => {\n      console.log(`queue for master: ${this._data['device']['macAddress']}, has been unbinded`);\n      logger.info(`queue for master: ${this._data['device']['macAddress']}, has been unbinded`);\n      this.deleteDevice(done);\n    });\n  }\n\n  /**\n   *\n   * @param {Function} done\n   */\n  disconnectFromManager(done) {\n    this._queue.close(`pubsub`, this._data['device']['macAddress'], () => {\n      console.log(`queue for manager: ${this._data['device']['macAddress']}, has been unbinded`);\n      logger.info(`queue for manager: ${this._data['device']['macAddress']}, has been unbinded`);\n      this.deleteDevice(done);\n    });\n  }\n\n  /**\n   *\n   * @param {Function} done\n   */\n  disconnectFromSlave(done) {\n    let beforeClose = () => {\n      console.log(`queue for slave ${this._data['device']['macAddress']}, is going to be removed from masters and managers`);\n      logger.info(`queue for slave ${this._data['device']['macAddress']}, is going to be removed from masters and managers`);\n      this._queue.close(`topic`, this._data['device']['macAddress'], () => {\n        console.log(`queue for slave: ${this._data['device']['macAddress']}, has been unbinded`);\n        logger.info(`queue for slave: ${this._data['device']['macAddress']}, has been unbinded`);\n        this.deleteDevice(done);\n      });\n    };\n\n    //let timeout = 20;\n    //let interval = setInterval(() => {\n\n    //console.log('click');\n    //logger.info('click');\n\n    if (this._send) {\n      //stopFunction();\n      return this._send(JSON.stringify({\n        type: 'service', message: {\n          action: 'slaveDisconnected',\n          content: { role: 'slave', status: 'disconnected', id: this._data['device']['macAddress'] },\n          time: new Date()\n        }\n      }), () => {\n        setTimeout(beforeClose, 1000);\n      });\n    }\n\n    return beforeClose();\n    //if (--timeout < 1) {\n    //  stopFunction();\n    //  return done();\n    //}\n    //}, 1000);\n\n    //function stopFunction() {\n    //  clearInterval(interval);\n    //}\n  }\n\n}\n\n"]}