{"version":3,"sources":["message.es6"],"names":[],"mappings":"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","file":"message.js","sourcesContent":["/**\n * Created by michaelsilvestre on 19/05/15\n */\n\nimport { adapters } from \"../adapters/absAdapter.js\";\nimport Queue from '../modules/queue.js'\nimport _ from \"underscore\";\nimport { logger } from \"../lib/logger.js\"\nimport async from 'async'\n\n/**\n * Container a dictionnary with all the talkers\n *\n * @type {{masters: {}, managers: {}, slaves: {}}}\n */\nlet devicesContainer = {\n  masters: {},\n  managers: {},\n  slaves: {}\n};\n\n/**\n * Process to disconnect the talker when the server stop\n *\n * @param next\n */\nexport let close1 = (next) => {\n  console.log('close message');\n\n  Object.keys(devicesContainer).forEach((deviceListKey) => {\n    console.log(`disconnect device container: ${deviceListKey}`);\n    logger.info(`disconnect device container: ${deviceListKey}`);\n\n    Object.keys(devicesContainer[deviceListKey]).forEach((essaimKey) => {\n      console.log(`disconnect device essaim: ${essaimKey}`);\n      logger.info(`disconnect device essaim: ${essaimKey}`);\n\n      Object.keys(devicesContainer[deviceListKey][essaimKey]).forEach((deviceKey) => {\n        console.log(`disconnect device: ${deviceKey}`);\n        logger.info(`disconnect device: ${deviceKey}`);\n\n        let device = devicesContainer[deviceListKey][essaimKey][deviceKey];\n        device.socket.emit('disconnect');\n        device.socket.disconnect();\n      });\n    });\n  });\n\n  next();\n};\n\n/**\n * Process to disconnect the talker when the server stop\n *\n * @param next\n */\nexport let close = (next) => {\n  console.log('close message');\n\n  async.forEachOfSeries(devicesContainer, (essaimList, deviceListKey, cbDeviceList) => {\n    console.log(`disconnect device container: ${deviceListKey}`);\n    logger.info(`disconnect device container: ${deviceListKey}`);\n\n    async.forEachOf(essaimList, (essaim, essaimKey, cbEssaim) => {\n      console.log(`disconnect device essaim: ${essaimKey}`);\n      logger.info(`disconnect device essaim: ${essaimKey}`);\n\n      async.forEachOf(essaim, (device, deviceKey, cbDevice) => {\n        console.log(`disconnect device: ${deviceKey}`);\n        logger.info(`disconnect device: ${deviceKey}`);\n\n        device.socket.emit('disconnect');\n        device.socket.disconnect();\n\n        cbDevice();\n      }, (err) => {\n        if (err) {\n          console.warn(err);\n          logger.warn(err);\n        }\n      });\n\n      cbEssaim();\n    }, (err) => {\n      if (err) {\n        console.warn(err);\n        logger.warn(err);\n      }\n    });\n\n    cbDeviceList();\n  }, (err) => {\n    if (err) {\n      console.warn(err);\n      logger.warn(err);\n    }\n\n    next();\n  });\n\n};\n\n/**\n *\n */\nexport class LinkDevice {\n  /**\n   *\n   * @param {Object} data\n   * @param {socket.io} socket\n   * @param {Function} callback\n   */\n  constructor(data, socket, callback) {\n    this._queue = new Queue(adapters.getAdapter('queue'), data['application']['businessId']);\n    this._socket = socket;\n    this._data = data;\n    this._send = null;\n\n    //if (!this.hasOwnProperty(action)) {\n    //  throw new Error(`The property: ${action}, not exist`);\n    //}\n    class Starter {\n      constructor() {\n\n      }\n      static master(context, callback) {\n        context.registerMaster(callback);\n      }\n      static manager(context, callback) {\n        context.registerManager(callback);\n      }\n      static slave(context, callback) {\n        context.registerSlave(callback);\n      }\n    }\n\n    try {\n      Starter[data.device.role](this, callback);\n    } catch (e) {\n      console.warn(new Error(`The property: ${data.device.role}, not exist: ${e}`));\n      logger.warn(new Error(`The property: ${data.device.role}, not exist: ${e}`));\n    }\n  }\n\n  /**\n   *\n   * @param {Function} next\n   */\n  createIfNotExistListDevices(next) {\n    if (!devicesContainer.hasOwnProperty(`${this._data.device.role}s`)) {\n      return next(new Error(`The container don't contain a object: ${this._data.device.role}s`));\n    }\n    if (!devicesContainer[`${this._data.device.role}s`].hasOwnProperty(`${this._data['application']['businessId']}`)) {\n      devicesContainer[`${this._data.device.role}s`][`${this._data['application']['businessId']}`] = {};\n      return next();\n    }\n    if (devicesContainer[`${this._data.device.role}s`][this._data['application']['businessId']].hasOwnProperty(this._data['device']['macAddress'])) {\n      return next(new Error(`The queue: ${this._data['device']['role']}, still contain a key: ${this._data['device']['macAddress']}`));\n    }\n    next();\n  }\n\n  /**\n   *\n   * @param {Object} data\n   * @returns {Object}\n   */\n  createFakeList(data) {\n    let fakeList = {};\n    fakeList[`${data['application']['businessId']}`] = {};\n    fakeList[`${data['application']['businessId']}`][`${data['device']['macAddress']}`] = this;\n\n    return fakeList;\n  }\n\n  /**\n   *\n   * @param {Function} next\n   */\n  registerMaster(next) {\n    this.createIfNotExistListDevices((err) => {\n      if (err) {\n        return next(err);\n      }\n\n      devicesContainer.masters[`${this._data['application']['businessId']}`][`${this._data['device']['macAddress']}`] = this;\n\n      this.createSubQueue(`pubsub`, this._data['application']['businessId'], this.createFakeList(this._data), () => {\n        console.log(`${this._data['device']['macAddress']} has been added to the SubPub queue of the essaim ${this._data['application']['businessId']}`);\n        logger.info(`${this._data['device']['macAddress']} has been added to the SubPub queue of the essaim ${this._data['application']['businessId']}`);\n        this._queue.registerSelectorQueue(`topic`, (callback) => {\n          this._send = callback;\n          this._socket.on('message', (chunk) => {\n            let { key, message } = JSON.parse(chunk);\n            if (message) {\n              return callback(message, key);\n            }\n            return callback(chunk);\n          });\n          next(null, this._data['device'], devicesContainer.slaves[`${this._data['application']['businessId']}`] || {});\n        });\n      });\n\n    });\n\n  }\n\n  /**\n   *\n   * @param {Function} next\n   */\n  registerManager(next) {\n    this.createIfNotExistListDevices((err) => {\n      if (err) {\n        return next(err);\n      }\n\n      devicesContainer.managers[`${this._data['application']['businessId']}`][`${this._data['device']['macAddress']}`] = this;\n\n      this.createSubQueue(`pubsub`, this._data['application']['businessId'], this.createFakeList(this._data), () => {\n        console.log(`${this._data['device']['macAddress']} has been added to the SubPub queue of the essaim ${this._data['application']['businessId']}`);\n        logger.info(`${this._data['device']['macAddress']} has been added to the SubPub queue of the essaim ${this._data['application']['businessId']}`);\n        this._queue.registerSelectorQueue(`topic`, (callback) => {\n          this._send = callback;\n          this._socket.on('message', (chunk) => {\n            let { key, message } = JSON.parse(chunk);\n            if (message) {\n              return callback(message, key);\n            }\n            return callback(chunk);\n          });\n          next(null, this._data['device'], devicesContainer.slaves[`${this._data['application']['businessId']}`] || {});\n        });\n      });\n    });\n  }\n\n  /**\n   *\n   * @param {Function} next\n   */\n  registerSlave(next) {\n    this.createIfNotExistListDevices((err) => {\n      if (err) {\n        return next(err);\n      }\n\n      devicesContainer.slaves[`${this._data['application']['businessId']}`][`${this._data['device']['macAddress']}`] = this;\n\n      this.createTopicQueue(`topic`, this._data['application']['businessId'], this._data['device']['macAddress'], this.createFakeList(this._data), () => {\n        console.log(`${this._data['device']['macAddress']} has been added to the Topic queue of the essaim ${this._data['application']['businessId']}`);\n        logger.info(`${this._data['device']['macAddress']} has been added to the Topic queue of the essaim ${this._data['application']['businessId']}`);\n        this._queue.registerPubQueue(`pubsub`, (callback) => {\n          this._send = callback;\n          callback(JSON.stringify({\n            type: 'service', message: {\n              action: 'connection',\n              content: { role: 'slave', status: 'connected', id: this._data['device']['macAddress'] },\n              time: new Date()\n            }\n          }));\n          this._socket.on('message', (message) => {\n            let messageObj = JSON.parse(message);\n            messageObj.slaveId = this._data['device']['macAddress'];\n            callback(JSON.stringify(messageObj));\n          });\n          next(null, this._data['device']);\n        });\n      });\n\n    });\n  }\n\n  /**\n   *\n   * @param {String} queue\n   * @param {String} essaim\n   * @param {Object} list\n   * @param {Function} next\n   */\n  createSubQueue(queue, essaim, list, next) {\n    let keys = Object.keys(list[essaim] || {})\n      , numKey = keys.length;\n\n    if (keys.length < 1) {\n      return next();\n    }\n\n    keys.forEach((key) => {\n      this._queue.registerSubQueue(queue, (message) => {\n        if (!message) {\n          return;\n        }\n        console.log('subQueue message: ' + message.content.toString());\n        logger.info('subQueue message: ' + message.content.toString());\n        let {type: type, message: msg} = JSON.parse(message.content.toString());\n        if (!type) {\n          return list[essaim][key].socket.emit('message', message);\n        }\n        list[essaim][key].socket.emit(type, msg);\n      }, () => {\n        if (--numKey === 0) {\n          next();\n        }\n      });\n    });\n  }\n\n  /**\n   *\n   * @param {string} queue\n   * @param {String} essaim\n   * @param {String} deviceId\n   * @param {Object} list\n   * @param {Function} next\n   */\n  createTopicQueue(queue, essaim, deviceId, list, next) {\n    let keys = Object.keys(list[essaim] || {})\n      , numKey = keys.length;\n\n    if (keys.length < 1) {\n      return next();\n    }\n\n    keys.forEach((key) => {\n      this._queue.registerTopicQueue(queue, [\"broadcast\", deviceId], (message) => {\n        if (!message) {\n          return;\n        }\n        console.log('topicQueue message: ' + message.content.toString());\n        logger.info('topicQueue message: ' + message.content.toString());\n        list[essaim][key].socket.emit('message', message);\n      }, () => {\n        if (--numKey === 0) {\n          next();\n        }\n      });\n    });\n  }\n\n  /**\n   *\n   * @returns {*|LinkDevice.socket}\n   */\n  get socket() {\n    return this._socket;\n  }\n\n  /**\n   *\n   * @param {*|Function} done\n   */\n  disconnect(done) {\n    let action = `disconnectFrom${this._data['device']['role'].charAt(0).toUpperCase()}${this._data['device']['role'].slice(1)}`;\n    console.log(`action: ${action}`);\n    logger.info(`action: ${action}`);\n\n    //if (!this.hasOwnProperty(action)) {\n    //  throw new Error(`The property: ${action}, not exist`);\n    //}\n    try {\n      this[action](done);\n    } catch (e) {\n      console.warn(new Error(`The property: ${action}, not exist: ${e}`));\n      logger.warn(new Error(`The property: ${action}, not exist: ${e}`));\n    }\n  }\n\n  /**\n   *\n   * @param {Function} done\n   * @returns {*}\n   */\n  deleteDevice(done) {\n    done = \"function\" === typeof done ? done : (value) => {\n      return value;\n    };\n    if (!devicesContainer.hasOwnProperty(`${this._data.device.role}s`)) {\n      throw new Error(`The deviceContainer don't contain a container: ${this._data.device.role}s`);\n    }\n    if (!devicesContainer[`${this._data.device.role}s`][this._data['application']['businessId']] || !devicesContainer[`${this._data.device.role}s`][this._data['application']['businessId']][this._data['device']['macAddress']]) {\n      return done(new Error('Nothing to do'));\n    }\n    delete(devicesContainer[`${this._data.device.role}s`][this._data['application']['businessId']][this._data['device']['macAddress']]);\n    console.log(`device: ${[this._data['device']['macAddress']]}, has been removed from: ${this._data['application']['businessId']}`);\n    logger.info(`device: ${[this._data['device']['macAddress']]}, has been removed from: ${this._data['application']['businessId']}`);\n    return done();\n  }\n\n  /**\n   *\n   * @param {Function} done\n   */\n  disconnectFromMaster(done) {\n    this._queue.close(`pubsub`, '', () => {\n      console.log(`queue for master: ${this._data['device']['macAddress']}, has been unbinded`);\n      logger.info(`queue for master: ${this._data['device']['macAddress']}, has been unbinded`);\n      this.deleteDevice(done);\n    });\n  }\n\n  /**\n   *\n   * @param {Function} done\n   */\n  disconnectFromManager(done) {\n    this._queue.close(`pubsub`, this._data['device']['macAddress'], () => {\n      console.log(`queue for manager: ${this._data['device']['macAddress']}, has been unbinded`);\n      logger.info(`queue for manager: ${this._data['device']['macAddress']}, has been unbinded`);\n      this.deleteDevice(done);\n    });\n  }\n\n  /**\n   *\n   * @param {Function} done\n   */\n  disconnectFromSlave(done) {\n    let beforeClose = () => {\n      console.log(`queue for slave ${this._data['device']['macAddress']}, is going to be removed from masters and managers`);\n      logger.info(`queue for slave ${this._data['device']['macAddress']}, is going to be removed from masters and managers`);\n      this._queue.close(`topic`, this._data['device']['macAddress'], () => {\n        console.log(`queue for slave: ${this._data['device']['macAddress']}, has been unbinded`);\n        logger.info(`queue for slave: ${this._data['device']['macAddress']}, has been unbinded`);\n        this.deleteDevice(done);\n      });\n    };\n\n    //let timeout = 20;\n    //let interval = setInterval(() => {\n\n    //console.log('click');\n    //logger.info('click');\n\n    if (this._send) {\n      //stopFunction();\n      return this._send(JSON.stringify({\n        type: 'service', message: {\n          action: 'slaveDisconnected',\n          content: { role: 'slave', status: 'disconnected', id: this._data['device']['macAddress'] },\n          time: new Date()\n        }\n      }), () => {\n        setTimeout(beforeClose, 1000);\n      });\n    }\n\n    return beforeClose();\n    //if (--timeout < 1) {\n    //  stopFunction();\n    //  return done();\n    //}\n    //}, 1000);\n\n    //function stopFunction() {\n    //  clearInterval(interval);\n    //}\n  }\n\n  /**\n   * Return socket\n   * @returns {socket.io}\n   */\n  get socket() {\n    return this._socket;\n  }\n\n}\n\n"]}